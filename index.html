<!DOCTYPE html>
<body onload="checkLogin(event)">
    <div> 
        <h1>Demo webstore API</h1> 
    </div> 
    <div> 
        <h3>WIP by Aku Laurila</h3> 
    </div>
    <div> 
        <p>An express API for use with a demo webstore.</p> 
    </div>
    <ul> 
        <li>
            <a href='https://akulaurila.com'>Home page</a>
        </li>
        <li>
            <a href='https://github.com/Ka-Q'>GitHub</a>
        </li> 
    </ul>
    <input type='text' placeholder="email" id='email'/>
    <input type='password' placeholder="password" id='password'/>
    <button id='btn' onclick="handleLogIn(event)">Log in</button>
    <button id='btn2' onclick="handleLogOut(event)">Log out</button>
    <p id="logInInfo"></p>
    <p id="isLoggedInInfo"></p>
</body>

<script>
    const handleLogIn = async (e) => {
        let emailInput = document.getElementById("email");
        let passwordInput = document.getElementById("password");
        let loginInfo = document.getElementById("logInInfo");

        let email = emailInput.value;
        let password = passwordInput.value;
        console.log(email + ", " + password);
        let f = await fetch("http://localhost:5000/api/login", {
            method: "POST",
            credentials: "include",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_email: email, user_password: password })
        });
        let result = await f.json();
        if (f.status == 200) {
            loginInfo.innerText = ""
        } else {
            loginInfo.innerText = "log in failed"
        }
        checkLogin();
    }   

    const handleLogOut = async (e) => {

        let f = await fetch("http://localhost:5000/api/logout", {
            method: "POST",
            credentials: "include",
            headers: {
                'Content-Type': 'application/json'
            }
        });
        let result = await f.json();
        location.reload();
    }   

    const checkLogin = async (e) => {
        let isLoggedinInfo = document.getElementById("isLoggedInInfo");
        let f = await fetch("http://localhost:5000/api/check_login", {
            method: "POST",
            credentials: "include",
            headers: {
                'Content-Type': 'application/json'
            }
        });
        let result = await f.json();
        if (f.status == 200) {
            isLoggedinInfo.innerText = "logged in as " + result.user_email;
        } else {
            isLoggedinInfo.innerText = "not logged in";
        }
    }
</script>